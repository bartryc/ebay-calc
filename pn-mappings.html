<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapowania PN</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div>
        <div class="eyebrow">Narzędzie sprzedażowe</div>
        <h1>Mapowania PN → producent</h1>
        <p class="subtitle">Dodawaj, edytuj i usuwaj mapowania używane w sugestiach.</p>
      </div>
      <div class="top-actions">
        <nav class="top-menu" aria-label="Główne menu">
          <a class="top-menu-link" href="index.html">
            <span class="top-menu-icon" aria-hidden="true">
              <img src="resources/icon-calc.svg" alt="">
            </span>
            <span>Kalkulator</span>
          </a>
          <a class="top-menu-link is-active" href="pn-mappings.html" aria-current="page">
            <span class="top-menu-icon" aria-hidden="true">
              <img src="resources/icon-mapping.svg" alt="">
            </span>
            <span>Mapowania</span>
          </a>
          <button id="themeToggleBtn" class="top-menu-toggle icon-only" aria-label="Zmień motyw">
            <span class="top-menu-icon" aria-hidden="true">
              <img class="theme-icon theme-icon-dark" src="resources/icon-dark-mode.svg" alt="">
              <img class="theme-icon theme-icon-light" src="resources/icon-light-mode.svg" alt="">
            </span>
          </button>
        </nav>
      </div>
    </header>

    <section class="app-card">
      <div class="mapping-help">
        <strong>Wzorce:</strong> `x` = jedna cyfra, `*` = jeden dowolny znak, `+` = dowolny ciąg znaków.
        <span class="mapping-help-examples">Przykłady: `xxxxx`, `0xxxxx`, `******-***`, `AFBR+`</span>
      </div>
      <div class="search-row">
        <input type="text" id="pnKeyInput" maxlength="64" placeholder="PN lub wzorzec (np. JVFVR, 100-000000xxx)">
        <input type="text" id="pnVendorInput" maxlength="64" placeholder="Producent (np. Dell, AMD, HPE)">
        <div class="search-actions">
          <button type="button" id="saveMappingBtn" aria-label="Zapisz">✓</button>
        </div>
      </div>
      <div class="search-status" id="pnMappingStatus" aria-live="polite"></div>
      <div class="search-row">
        <input type="text" id="mappingFilterInput" maxlength="64" placeholder="Szukaj w mapowaniach (PN / wzorzec / producent)">
      </div>
      <div id="mappingList" class="history-list"></div>
      <div id="patternList" class="history-list"></div>
    </section>
  </div>

  <div id="mappingToastStack" class="mapping-toast-stack" role="status" aria-live="polite"></div>

  <div id="mappingModal" class="mapping-modal" style="display: none;">
    <div class="mapping-modal-card" role="dialog" aria-modal="true" aria-labelledby="mappingModalTitle">
      <div class="mapping-modal-header">
        <strong id="mappingModalTitle">Edytuj mapowanie</strong>
        <button type="button" id="mappingModalClose" aria-label="Zamknij">×</button>
      </div>
      <div class="mapping-modal-body">
        <label for="mappingModalKey" id="mappingModalKeyLabel">PN</label>
        <input type="text" id="mappingModalKey" maxlength="64">
        <label for="mappingModalVendor">Producent</label>
        <input type="text" id="mappingModalVendor" maxlength="64">
      </div>
      <div class="mapping-modal-actions">
        <button type="button" id="mappingModalSave">Zapisz</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="mapping-modal" style="display: none;">
    <div class="mapping-modal-card" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
      <div class="mapping-modal-header">
        <strong id="confirmModalTitle">Potwierdź usunięcie</strong>
        <button type="button" id="confirmModalClose" aria-label="Zamknij">×</button>
      </div>
      <div class="mapping-modal-body">
        <p id="confirmModalMessage"></p>
      </div>
      <div class="mapping-modal-actions confirm-actions">
        <button type="button" id="confirmModalCancel">Anuluj</button>
        <button type="button" id="confirmModalOk" class="btn-danger">Usuń</button>
      </div>
    </div>
  </div>

  <script src="pn-mappings.js"></script>
  <script>
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const body = document.body;

    function updateThemeToggleLabel(isDark) {
      const label = isDark ? 'Włącz tryb jasny' : 'Włącz tryb ciemny';
      themeToggleBtn.setAttribute('aria-label', label);
      themeToggleBtn.setAttribute('title', label);
    }

    if (localStorage.getItem('theme') === 'dark') {
      body.classList.add('dark-mode');
    }
    updateThemeToggleLabel(body.classList.contains('dark-mode'));

    themeToggleBtn.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      const isDark = body.classList.contains('dark-mode');
      updateThemeToggleLabel(isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    const list = document.getElementById('mappingList');
    const keyInput = document.getElementById('pnKeyInput');
    const vendorInput = document.getElementById('pnVendorInput');
    const statusEl = document.getElementById('pnMappingStatus');
    const mappingFilterInput = document.getElementById('mappingFilterInput');
    const saveBtn = document.getElementById('saveMappingBtn');
    let currentFilter = '';
    const toastStack = document.getElementById('mappingToastStack');
    const downloadBackupBtn = document.getElementById('downloadBackupBtn');
    const restoreBackupBtn = document.getElementById('restoreBackupBtn');
    const backupFileInput = document.getElementById('backupFileInput');
    const modal = document.getElementById('mappingModal');
    const modalClose = document.getElementById('mappingModalClose');
    const modalSave = document.getElementById('mappingModalSave');
    const modalKey = document.getElementById('mappingModalKey');
    const modalVendor = document.getElementById('mappingModalVendor');
    const modalKeyLabel = document.getElementById('mappingModalKeyLabel');
    const confirmModal = document.getElementById('confirmModal');
    const confirmModalClose = document.getElementById('confirmModalClose');
    const confirmModalTitle = document.getElementById('confirmModalTitle');
    const confirmModalMessage = document.getElementById('confirmModalMessage');
    const confirmModalCancel = document.getElementById('confirmModalCancel');
    const confirmModalOk = document.getElementById('confirmModalOk');
    let confirmResolve = null;

    function openModal(mode, payload) {
      modal.dataset.mode = mode;
      if (mode === 'exact') {
        modal.dataset.originalKey = payload.key;
        modalKeyLabel.textContent = 'PN';
        modalKey.value = payload.key;
      } else {
        modal.dataset.patternIndex = payload.index;
        modalKeyLabel.textContent = 'Wzorzec';
        modalKey.value = payload.pattern;
      }
      modalVendor.value = payload.vendor;
      modal.style.display = 'flex';
      modalKey.focus();
    }

    function closeModal() {
      modal.style.display = 'none';
      modal.dataset.mode = '';
      modal.dataset.originalKey = '';
      modal.dataset.patternIndex = '';
    }

    function openConfirm({ title, message, confirmLabel = 'Usuń', cancelLabel = 'Anuluj' }) {
      confirmModalTitle.textContent = title;
      confirmModalMessage.textContent = message;
      confirmModalOk.textContent = confirmLabel;
      confirmModalCancel.textContent = cancelLabel;
      confirmModal.style.display = 'flex';
      confirmModalOk.focus();
      return new Promise((resolve) => {
        confirmResolve = resolve;
      });
    }

    function closeConfirm(result) {
      confirmModal.style.display = 'none';
      if (confirmResolve) {
        confirmResolve(result);
        confirmResolve = null;
      }
    }

    function showToast(message, variant) {
      if (!toastStack) return;
      const maxToasts = 6;
      while (toastStack.children.length >= maxToasts) {
        toastStack.firstElementChild?.remove();
      }
      const toast = document.createElement('div');
      toast.className = 'mapping-toast';
      if (variant === 'warn') toast.classList.add('is-warn');
      if (variant === 'ok') toast.classList.add('is-ok');
      toast.textContent = message || '';
      toastStack.append(toast);
      requestAnimationFrame(() => {
        toast.classList.add('is-visible');
      });
      setTimeout(() => {
        toast.classList.remove('is-visible');
        setTimeout(() => toast.remove(), 200);
      }, 10000);
    }

    function logMappingAction(action, meta = {}) {
      if (!window.PN_MAPPINGS_API?.log) return;
      window.PN_MAPPINGS_API.log('mapping', { action, ...meta });
    }

    function isValidPattern(value) {
      const normalized = value.replace(/\s+/g, '');
      return /^[a-z0-9x*+\-]+$/i.test(normalized);
    }

    function shouldTreatAsPattern(value) {
      return /[x*+]/i.test(value);
    }

    function downloadBackup() {
      const data = window.PN_MAPPINGS_API.get();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const now = new Date();
      const stamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
      const link = document.createElement('a');
      link.href = url;
      link.download = `pn-mappings-backup-${stamp}.json`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
      showToast('Backup zapisany do pliku.', 'ok');
    }

    function restoreBackupFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          const normalized = window.PN_MAPPINGS_API.normalizeData(parsed);
          window.PN_MAPPINGS_API.set(normalized);
          renderMappings();
          showToast('Przywrócono backup z pliku.', 'ok');
          logMappingAction('restore', { source: 'file' });
        } catch (error) {
          showToast('Nie udało się odczytać pliku backupu.', 'warn');
        }
      };
      reader.readAsText(file);
    }

    function renderMappings(filterValue) {
      const data = window.PN_MAPPINGS_API.get();
      const activeFilter = typeof filterValue === 'string' ? filterValue : currentFilter;
      const filter = activeFilter.trim().toLowerCase();
      const entries = Object.entries(data.exact || {}).filter(([key, vendor]) => {
        if (!filter) return true;
        return key.toLowerCase().includes(filter) || String(vendor).toLowerCase().includes(filter);
      });
      if (!entries.length) {
        list.innerHTML = '<div class="history-item"><strong>Brak mapowań</strong><div class="history-meta">Dodaj pierwsze mapowanie powyżej.</div></div>';
      } else {
        list.innerHTML = entries
          .sort((a, b) => a[0].localeCompare(b[0]))
          .map(([key, vendor]) => `
            <div class="history-item">
              <div class="history-row">
                <strong>${key}</strong>
                <div class="history-actions-inline">
                  <button type="button" class="history-copy" data-key="${key}" aria-label="Edytuj">Edytuj</button>
                  <button type="button" class="history-remove" data-key="${key}" aria-label="Usuń">×</button>
                </div>
              </div>
              <div class="history-summary">Producent: <span class="history-value">${vendor}</span></div>
            </div>
          `)
          .join('');
      }

      const patterns = Array.isArray(data.patterns) ? data.patterns : [];
      const patternList = document.getElementById('patternList');
      if (patternList) {
        const filteredPatterns = patterns.filter(rule => {
          if (!filter) return true;
          return String(rule.pattern).toLowerCase().includes(filter) || String(rule.vendor).toLowerCase().includes(filter);
        });
        if (!filteredPatterns.length) {
          patternList.innerHTML = '<div class="history-item"><strong>Brak wzorców</strong><div class="history-meta">Dodaj pierwszy wzorzec powyżej.</div></div>';
        } else {
          patternList.innerHTML = filteredPatterns
            .map((rule, index) => `
              <div class="history-item">
                <div class="history-row">
                  <strong>Wzorzec: ${rule.pattern}</strong>
                  <div class="history-actions-inline">
                    <button type="button" class="history-copy" data-pattern-index="${index}" aria-label="Edytuj">Edytuj</button>
                    <button type="button" class="history-remove" data-pattern-index="${index}" aria-label="Usuń">×</button>
                  </div>
                </div>
                <div class="history-summary">Producent: <span class="history-value">${rule.vendor}</span></div>
              </div>
            `)
            .join('');
        }
      }
    }

    function saveMapping() {
      const rawKey = keyInput.value.trim();
      const vendor = vendorInput.value.trim();
      if (!rawKey || !vendor) {
        showToast('Uzupełnij PN i producenta.', 'warn');
        return;
      }
      const data = window.PN_MAPPINGS_API.get();
      const isPattern = shouldTreatAsPattern(rawKey);
      if (isPattern) {
        if (!isValidPattern(rawKey)) {
          showToast('Wzorzec może zawierać tylko litery, cyfry, x, *, + i -.', 'warn');
          return;
        }
        const pattern = window.PN_MAPPINGS_API.normalizePattern(rawKey);
        data.patterns = Array.isArray(data.patterns) ? data.patterns : [];
        if (data.patterns.some(rule => rule.pattern === pattern)) {
          showToast(`Wzorzec ${pattern} już istnieje.`, 'warn');
          return;
        }
        data.patterns.push({ pattern, vendor });
        window.PN_MAPPINGS_API.set(data);
        showToast(`Zapisano wzorzec: ${pattern} → ${vendor}`, 'ok');
        logMappingAction('add-pattern', { pattern, vendor });
      } else {
        const key = window.PN_MAPPINGS_API.normalize(rawKey);
        data.exact = data.exact || {};
        if (data.exact[key]) {
          showToast(`PN ${key} już istnieje.`, 'warn');
          return;
        }
        data.exact[key] = vendor;
        window.PN_MAPPINGS_API.set(data);
        showToast(`Zapisano: ${key} → ${vendor}`, 'ok');
        logMappingAction('add-exact', { key, vendor });
      }
      keyInput.value = '';
      vendorInput.value = '';
      renderMappings();
    }

    saveBtn.addEventListener('click', () => {
      saveMapping();
    });
    [keyInput, vendorInput].forEach((input) => {
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          saveMapping();
        }
      });
    });
    if (downloadBackupBtn) {
      downloadBackupBtn.addEventListener('click', () => {
        downloadBackup();
      });
    }
    if (restoreBackupBtn && backupFileInput) {
      restoreBackupBtn.addEventListener('click', () => {
        backupFileInput.click();
      });
      backupFileInput.addEventListener('change', (event) => {
        const file = event.target.files?.[0];
        if (file) restoreBackupFile(file);
        backupFileInput.value = '';
      });
    }

    list.addEventListener('click', async (event) => {
      const target = event.target;
      if (!target) return;
      if (target.classList.contains('history-remove')) {
        const key = target.getAttribute('data-key');
        const confirmed = await openConfirm({
          title: 'Usuń mapowanie',
          message: `Czy na pewno usunąć mapowanie: ${key}?`
        });
        if (!confirmed) {
          return;
        }
        const data = window.PN_MAPPINGS_API.get();
        if (data.exact) {
          delete data.exact[key];
          window.PN_MAPPINGS_API.set(data);
        }
        renderMappings();
        showToast(`Usunięto: ${key}`, 'ok');
        logMappingAction('delete-exact', { key });
        return;
      }
      if (target.classList.contains('history-copy')) {
        const key = target.getAttribute('data-key');
        const data = window.PN_MAPPINGS_API.get();
        if (data.exact && data.exact[key]) {
          openModal('exact', { key, vendor: data.exact[key] });
        }
      }
    });

    patternList.addEventListener('click', async (event) => {
      const target = event.target;
      if (!target) return;
      if (target.classList.contains('history-remove')) {
        const index = parseInt(target.getAttribute('data-pattern-index'), 10);
        if (Number.isNaN(index)) return;
        const data = window.PN_MAPPINGS_API.get();
        if (Array.isArray(data.patterns)) {
          const removed = data.patterns[index];
          const confirmed = await openConfirm({
            title: 'Usuń wzorzec',
            message: `Czy na pewno usunąć wzorzec: ${removed?.pattern || '(bez nazwy)'}?`
          });
          if (!confirmed) {
            return;
          }
          data.patterns.splice(index, 1);
          window.PN_MAPPINGS_API.set(data);
          renderMappings();
          if (removed?.pattern) {
            showToast(`Usunięto wzorzec: ${removed.pattern}`, 'ok');
            logMappingAction('delete-pattern', { pattern: removed.pattern });
          } else {
            showToast('Usunięto wzorzec.', 'ok');
            logMappingAction('delete-pattern', {});
          }
        }
        return;
      }
      if (target.classList.contains('history-copy')) {
        const index = parseInt(target.getAttribute('data-pattern-index'), 10);
        if (Number.isNaN(index)) return;
        const data = window.PN_MAPPINGS_API.get();
        if (Array.isArray(data.patterns) && data.patterns[index]) {
          openModal('pattern', {
            index,
            pattern: data.patterns[index].pattern,
            vendor: data.patterns[index].vendor
          });
        }
      }
    });

    if (mappingFilterInput) {
      mappingFilterInput.addEventListener('input', () => {
        currentFilter = mappingFilterInput.value;
        renderMappings(currentFilter);
      });
    }

    modalClose.addEventListener('click', () => {
      closeModal();
    });
    modal.addEventListener('click', (event) => {
      if (event.target === modal) closeModal();
    });
    modalSave.addEventListener('click', () => {
      const mode = modal.dataset.mode;
      const rawKey = modalKey.value.trim();
      const vendor = modalVendor.value.trim();
      if (!rawKey || !vendor) {
        showToast('Uzupełnij PN/wzorzec i producenta.', 'warn');
        return;
      }
      const nextMode = shouldTreatAsPattern(rawKey) ? 'pattern' : 'exact';
      const data = window.PN_MAPPINGS_API.get();
      if (nextMode === 'exact') {
        const originalKey = modal.dataset.originalKey;
        const newKey = window.PN_MAPPINGS_API.normalize(rawKey);
        data.exact = data.exact || {};
        if (newKey !== originalKey && data.exact[newKey]) {
          showToast(`PN ${newKey} już istnieje.`, 'warn');
          return;
        }
        if (mode === 'pattern') {
          const index = parseInt(modal.dataset.patternIndex, 10);
          if (!Number.isNaN(index) && Array.isArray(data.patterns)) {
            data.patterns.splice(index, 1);
          }
        }
        if (originalKey && originalKey !== newKey) {
          delete data.exact[originalKey];
        }
        data.exact[newKey] = vendor;
      } else if (nextMode === 'pattern') {
        if (!isValidPattern(rawKey)) {
          showToast('Wzorzec może zawierać tylko litery, cyfry, x, *, + i -.', 'warn');
          return;
        }
        const index = parseInt(modal.dataset.patternIndex, 10);
        const newPattern = window.PN_MAPPINGS_API.normalizePattern(rawKey);
        data.patterns = Array.isArray(data.patterns) ? data.patterns : [];
        if (data.patterns.some((rule, idx) => rule.pattern === newPattern && idx !== index)) {
          showToast(`Wzorzec ${newPattern} już istnieje.`, 'warn');
          return;
        }
        if (mode === 'exact') {
          const originalKey = modal.dataset.originalKey;
          if (originalKey && data.exact) {
            delete data.exact[originalKey];
          }
          data.patterns.push({ pattern: newPattern, vendor });
        } else if (!Number.isNaN(index) && Array.isArray(data.patterns)) {
          data.patterns[index] = { pattern: newPattern, vendor };
        }
      }
      window.PN_MAPPINGS_API.set(data);
      renderMappings();
      showToast('Zapisano zmiany.', 'ok');
      logMappingAction('edit', { mode: nextMode });
      closeModal();
    });

    modal.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        modalSave.click();
      }
    });

    confirmModalClose.addEventListener('click', () => {
      closeConfirm(false);
    });
    confirmModalCancel.addEventListener('click', () => {
      closeConfirm(false);
    });
    confirmModalOk.addEventListener('click', () => {
      closeConfirm(true);
    });
    confirmModal.addEventListener('click', (event) => {
      if (event.target === confirmModal) closeConfirm(false);
    });
    document.addEventListener('keydown', (event) => {
      if (confirmModal.style.display !== 'none' && event.key === 'Escape') {
        closeConfirm(false);
      }
    });

    window.PN_MAPPINGS_API.load()
      .then(renderMappings)
      .catch(() => renderMappings());
  </script>
</body>
</html>
