<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin PN</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div>
        <div class="eyebrow">Narzędzie sprzedażowe</div>
        <h1>Admin mapowań PN</h1>
        <p class="subtitle">Backup i przywracanie mapowań.</p>
      </div>
      <div class="top-actions">
        <nav class="top-menu" aria-label="Główne menu">
          <a class="top-menu-link" href="index.html">
            <span class="top-menu-icon" aria-hidden="true">
              <img src="resources/icon-calc.svg" alt="">
            </span>
            <span>Kalkulator</span>
          </a>
          <a class="top-menu-link" href="pn-mappings.html">
            <span class="top-menu-icon" aria-hidden="true">
              <img src="resources/icon-mapping.svg" alt="">
            </span>
            <span>Mapowania</span>
          </a>
          <button id="themeToggleBtn" class="top-menu-toggle icon-only" aria-label="Zmień motyw">
            <span class="top-menu-icon" aria-hidden="true">
              <img class="theme-icon theme-icon-dark" src="resources/icon-dark-mode.svg" alt="">
              <img class="theme-icon theme-icon-light" src="resources/icon-light-mode.svg" alt="">
            </span>
          </button>
        </nav>
        <div class="top-admin-badge" title="Panel admina" aria-label="Panel admina">
          <span class="top-menu-icon" aria-hidden="true">
            <img src="resources/icon-admin.svg" alt="">
          </span>
          <span>Admin</span>
        </div>
      </div>
    </header>

    <section class="app-card admin-shell">
      <div class="admin-header-row">
        <div>
          <div class="eyebrow">Panel narzędzi</div>
          <h2>Kontrola mapowań</h2>
          <p class="subtitle">Backupy, przywracanie i szybkie testy w jednym miejscu.</p>
        </div>
      </div>

      <div class="admin-grid">
        <div class="admin-card">
          <h3>Backup mapowań</h3>
          <p>Zapisz bieżące mapowania do pliku JSON. Przyda się przed większymi zmianami.</p>
          <div class="admin-actions">
            <button type="button" id="downloadBackupBtn">Pobierz backup JSON</button>
            <button type="button" id="downloadFullBackupBtn">Pobierz pełny backup</button>
          </div>
          <div class="admin-meta">Ostatni backup: <span id="lastBackupValue">brak</span></div>
        </div>

        <div class="admin-card">
          <h3>Przywracanie</h3>
          <p>Wczytaj plik JSON i nadpisz mapowania w bazie.</p>
          <div class="admin-actions">
            <button type="button" id="restoreBackupBtn">Przywróć z pliku</button>
          </div>
          <div class="admin-meta warn">Uwaga: przywrócenie backupu nadpisuje bieżące mapowania.</div>
        </div>


        <div class="admin-card admin-card-wide">
          <h3>Status mapowań</h3>
          <div class="admin-kpis">
            <div class="admin-kpi">
              <span class="label">PN exact</span>
              <strong id="exactCount">—</strong>
            </div>
            <div class="admin-kpi">
              <span class="label">Wzorce</span>
              <strong id="patternCount">—</strong>
            </div>
            <div class="admin-kpi">
              <span class="label">Razem</span>
              <strong id="totalCount">—</strong>
            </div>
          </div>
          <div class="admin-meta">Ostatnia synchronizacja: <span id="lastSyncValue">—</span></div>
        </div>

        <div class="admin-card admin-card-wide">
          <details id="reportSection">
            <summary class="report-summary">
              <span>Zgłoszenia</span>
              <span class="report-count" id="reportCount">0</span>
            </summary>
            <p>Raporty z wyszukiwarki PN oraz błędy działania strony.</p>
            <div class="report-filter">
              <label for="reportFilter">Filtr zgłoszeń</label>
              <select id="reportFilter">
                <option value="all">Wszystkie</option>
                <option value="mapping">Tylko mapowania</option>
                <option value="ui" selected>Tylko błędy strony</option>
              </select>
            </div>
            <div id="reportList" class="report-list">Brak zgłoszeń.</div>
          </details>
        </div>

        <div class="admin-card admin-card-wide">
          <details id="logSection">
            <summary class="report-summary">
              <span>Historia operacji</span>
              <span class="report-count" id="logCount">0</span>
            </summary>
            <p>Lista ostatnich działań na backupach i zapisach (IP + data).</p>
            <div class="admin-log-controls">
              <div class="admin-log-field">
                <label for="logTypeFilter">Typ</label>
                <select id="logTypeFilter">
                  <option value="all" selected>Wszystko</option>
                  <option value="backup">Backup</option>
                  <option value="update">Update</option>
                  <option value="mapping">Mapowania</option>
                  <option value="mapping-report">Zgłoszenia</option>
                  <option value="calc">Przeliczenia</option>
                  <option value="search">Wyszukiwania</option>
                </select>
              </div>
              <div class="admin-log-field admin-log-field-wide">
                <label for="logQuery">Szukaj (IP / FP / UA / miasto)</label>
                <input type="text" id="logQuery" placeholder="np. 185.152, fp-123, Chrome, Warsaw">
              </div>
              <div class="admin-log-field">
                <label for="logPageSize">Na stronę</label>
                <select id="logPageSize">
                  <option value="10">10</option>
                  <option value="20" selected>20</option>
                  <option value="50">50</option>
                </select>
              </div>
              <div class="admin-log-field">
                <label>&nbsp;</label>
                <button type="button" id="logRefreshBtn">Odśwież logi</button>
              </div>
            </div>
            <div id="adminLogList" class="admin-log-list">Brak danych.</div>
            <div class="admin-log-pagination">
              <button type="button" id="logPrevBtn">Wstecz</button>
              <span id="logPageInfo">Strona 1 / 1</span>
              <button type="button" id="logNextBtn">Dalej</button>
            </div>
          </details>
        </div>

        <div class="admin-card admin-card-wide">
          <h3>Wskazówki</h3>
          <ul class="admin-list">
            <li>`x` = jedna cyfra, `*` = jeden dowolny znak, `+` = dowolny ciąg znaków.</li>
            <li>Po dużej edycji wykonaj backup, żeby nie stracić reguł.</li>
            <li>Backup przechowuj lokalnie z nazwą daty dla szybkiego przywrócenia.</li>
            <li>Jeśli coś wygląda podejrzanie, sprawdź logi IP i User-Agent.</li>
            <li>Dodawaj wzorce od najbardziej szczegółowych do ogólnych.</li>
          </ul>
        </div>
      </div>

      <input type="file" id="backupFileInput" accept="application/json" style="display: none;">
    </section>
  </div>

  <div id="mappingToastStack" class="mapping-toast-stack" role="status" aria-live="polite"></div>

  <div id="reportConfirmModal" class="mapping-modal" style="display: none;">
    <div class="mapping-modal-card" role="dialog" aria-modal="true" aria-labelledby="reportConfirmTitle">
      <div class="mapping-modal-header">
        <strong id="reportConfirmTitle">Potwierdź mapowanie</strong>
        <button type="button" id="reportConfirmClose" aria-label="Zamknij">×</button>
      </div>
      <div class="mapping-modal-body">
        <div class="report-meta" id="reportConfirmInfo"></div>
        <label for="reportConfirmKey">PN lub wzorzec</label>
        <input type="text" id="reportConfirmKey" maxlength="64">
        <label for="reportConfirmVendor">Producent</label>
        <input type="text" id="reportConfirmVendor" maxlength="64">
        <label for="reportConfirmType">Typ wpisu</label>
        <select id="reportConfirmType">
          <option value="auto" selected>Auto (PN lub wzorzec)</option>
          <option value="exact">PN exact</option>
          <option value="pattern">Wzorzec</option>
        </select>
        <label for="reportConfirmStatus">Status (dla błędów działania strony)</label>
        <select id="reportConfirmStatus">
          <option value="resolved" selected>Resolved</option>
          <option value="on-hold">On hold</option>
        </select>
        <label for="reportConfirmNote">Uwagi admina</label>
        <textarea id="reportConfirmNote" rows="2" placeholder="Opcjonalne uwagi admina"></textarea>
      </div>
      <div class="mapping-modal-actions confirm-actions">
        <button type="button" id="reportConfirmCancel">Anuluj</button>
        <button type="button" id="reportConfirmApply">Zastosuj</button>
      </div>
    </div>
  </div>

  <div id="reportDismissModal" class="mapping-modal" style="display: none;">
    <div class="mapping-modal-card" role="dialog" aria-modal="true" aria-labelledby="reportDismissTitle">
      <div class="mapping-modal-header">
        <strong id="reportDismissTitle">Usuń zgłoszenie?</strong>
        <button type="button" id="reportDismissClose" aria-label="Zamknij">×</button>
      </div>
      <div class="mapping-modal-body">
        <p id="reportDismissMessage">Czy na pewno chcesz usunąć to zgłoszenie?</p>
      </div>
      <div class="mapping-modal-actions confirm-actions">
        <button type="button" id="reportDismissCancel">Anuluj</button>
        <button type="button" id="reportDismissApply" class="btn-danger">Usuń</button>
      </div>
    </div>
  </div>

  <div id="reportRetypeModal" class="mapping-modal" style="display: none;">
    <div class="mapping-modal-card" role="dialog" aria-modal="true" aria-labelledby="reportRetypeTitle">
      <div class="mapping-modal-header">
        <strong id="reportRetypeTitle">Zmień typ zgłoszenia</strong>
        <button type="button" id="reportRetypeClose" aria-label="Zamknij">×</button>
      </div>
      <div class="mapping-modal-body">
        <p id="reportRetypeMessage">Czy na pewno chcesz zmienić typ tego zgłoszenia?</p>
      </div>
      <div class="mapping-modal-actions confirm-actions">
        <button type="button" id="reportRetypeCancel">Anuluj</button>
        <button type="button" id="reportRetypeApply">Zmień typ</button>
      </div>
    </div>
  </div>

  <script src="pn-mappings.js"></script>
  <script>
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const body = document.body;

    function updateThemeToggleLabel(isDark) {
      const label = isDark ? 'Włącz tryb jasny' : 'Włącz tryb ciemny';
      themeToggleBtn.setAttribute('aria-label', label);
      themeToggleBtn.setAttribute('title', label);
    }

    if (localStorage.getItem('theme') === 'dark') {
      body.classList.add('dark-mode');
    }
    updateThemeToggleLabel(body.classList.contains('dark-mode'));

    themeToggleBtn.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      const isDark = body.classList.contains('dark-mode');
      updateThemeToggleLabel(isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    const toastStack = document.getElementById('mappingToastStack');
    const downloadBackupBtn = document.getElementById('downloadBackupBtn');
    const downloadFullBackupBtn = document.getElementById('downloadFullBackupBtn');
    const restoreBackupBtn = document.getElementById('restoreBackupBtn');
    const backupFileInput = document.getElementById('backupFileInput');
    const lastBackupValue = document.getElementById('lastBackupValue');
    const lastSyncValue = document.getElementById('lastSyncValue');
    const adminLogList = document.getElementById('adminLogList');
    const logTypeFilter = document.getElementById('logTypeFilter');
    const logQuery = document.getElementById('logQuery');
    const logPageSize = document.getElementById('logPageSize');
    const logPrevBtn = document.getElementById('logPrevBtn');
    const logNextBtn = document.getElementById('logNextBtn');
    const logPageInfo = document.getElementById('logPageInfo');
    const logRefreshBtn = document.getElementById('logRefreshBtn');
    const reportList = document.getElementById('reportList');
    const reportCount = document.getElementById('reportCount');
    const reportFilter = document.getElementById('reportFilter');
    const logCount = document.getElementById('logCount');
    const reportConfirmModal = document.getElementById('reportConfirmModal');
    const reportConfirmClose = document.getElementById('reportConfirmClose');
    const reportConfirmCancel = document.getElementById('reportConfirmCancel');
    const reportConfirmApply = document.getElementById('reportConfirmApply');
    const reportConfirmInfo = document.getElementById('reportConfirmInfo');
    const reportConfirmKey = document.getElementById('reportConfirmKey');
    const reportConfirmVendor = document.getElementById('reportConfirmVendor');
    const reportConfirmType = document.getElementById('reportConfirmType');
    const reportConfirmStatus = document.getElementById('reportConfirmStatus');
    const reportConfirmNote = document.getElementById('reportConfirmNote');
    const reportDismissModal = document.getElementById('reportDismissModal');
    const reportDismissClose = document.getElementById('reportDismissClose');
    const reportDismissCancel = document.getElementById('reportDismissCancel');
    const reportDismissApply = document.getElementById('reportDismissApply');
    const reportDismissMessage = document.getElementById('reportDismissMessage');
    const reportRetypeModal = document.getElementById('reportRetypeModal');
    const reportRetypeClose = document.getElementById('reportRetypeClose');
    const reportRetypeCancel = document.getElementById('reportRetypeCancel');
    const reportRetypeApply = document.getElementById('reportRetypeApply');
    const reportRetypeMessage = document.getElementById('reportRetypeMessage');
    let pendingReportApply = null;
    let pendingReportDismiss = null;
    let pendingReportRetype = null;
    const exactCountEl = document.getElementById('exactCount');
    const patternCountEl = document.getElementById('patternCount');
    const totalCountEl = document.getElementById('totalCount');
    const ADMIN_LAST_BACKUP_KEY = 'adminLastBackup';
    const ADMIN_LAST_SYNC_KEY = 'adminLastSync';
    let logsCache = [];
    let totalLogs = null;
    let logPage = 1;

    function showToast(message, variant, durationMs) {
      if (!toastStack) return;
      const maxToasts = 6;
      while (toastStack.children.length >= maxToasts) {
        toastStack.firstElementChild?.remove();
      }
      const toast = document.createElement('div');
      toast.className = 'mapping-toast';
      if (variant === 'warn') toast.classList.add('is-warn');
      if (variant === 'info') toast.classList.add('is-info');
      if (variant === 'ok') toast.classList.add('is-ok');
      const suffix = ` (${Math.round(Number.isFinite(durationMs) ? durationMs : 0)} ms)`;
      toast.textContent = `${message || ''}${suffix}`;
      toastStack.append(toast);
      requestAnimationFrame(() => {
        toast.classList.add('is-visible');
      });
      setTimeout(() => {
        toast.classList.remove('is-visible');
        setTimeout(() => toast.remove(), 200);
      }, 8000);
    }

    function logAdminAction(action, meta = {}) {
      if (!window.PN_MAPPINGS_API?.log) return;
      window.PN_MAPPINGS_API.log('backup', { action, ...meta });
    }

    async function downloadBackup() {
      try {
        const t0 = performance.now();
        const resp = await window.PN_MAPPINGS_API.request('/backup', { method: 'GET' });
        if (!resp.ok) throw new Error('Backup failed');
        const data = await resp.json();
        const t1 = performance.now();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const now = new Date();
        const fileStamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
        const link = document.createElement('a');
        link.href = url;
        link.download = `pn-mappings-backup-${fileStamp}.json`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
        const displayStamp = new Date().toLocaleString('pl-PL');
        localStorage.setItem(ADMIN_LAST_BACKUP_KEY, displayStamp);
        if (lastBackupValue) lastBackupValue.textContent = displayStamp;
        showToast('Backup zapisany do pliku.', 'ok', t1 - t0);
        fetchLogs();
      } catch (error) {
        showToast('Nie udało się pobrać backupu z serwera.', 'warn');
      }
    }

    async function downloadFullBackup() {
      try {
        const t0 = performance.now();
        const resp = await window.PN_MAPPINGS_API.request('/backup/full', { method: 'GET' });
        if (!resp.ok) throw new Error('Full backup failed');
        const data = await resp.json();
        const t1 = performance.now();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const now = new Date();
        const fileStamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
        const link = document.createElement('a');
        link.href = url;
        link.download = `pn-full-backup-${fileStamp}.json`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
        const displayStamp = new Date().toLocaleString('pl-PL');
        localStorage.setItem(ADMIN_LAST_BACKUP_KEY, displayStamp);
        if (lastBackupValue) lastBackupValue.textContent = displayStamp;
        showToast('Pełny backup zapisany do pliku.', 'ok', t1 - t0);
        fetchLogs();
      } catch (error) {
        showToast('Nie udało się pobrać pełnego backupu.', 'warn');
      }
    }

    function restoreBackupFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          const normalized = window.PN_MAPPINGS_API.normalizeData(parsed);
          window.PN_MAPPINGS_API.set(normalized);
          updateStats(normalized);
          const stamp = new Date().toLocaleString('pl-PL');
          localStorage.setItem(ADMIN_LAST_SYNC_KEY, stamp);
          if (lastSyncValue) lastSyncValue.textContent = stamp;
          showToast('Przywrócono backup z pliku.', 'ok');
          logAdminAction('restore', { source: 'file' });
          fetchLogs();
        } catch (error) {
          showToast('Nie udało się odczytać pliku backupu.', 'warn');
        }
      };
      reader.readAsText(file);
    }

    downloadBackupBtn.addEventListener('click', () => {
      downloadBackup();
    });
    if (downloadFullBackupBtn) {
      downloadFullBackupBtn.addEventListener('click', () => {
        downloadFullBackup();
      });
    }
    restoreBackupBtn.addEventListener('click', () => {
      backupFileInput.click();
    });
    backupFileInput.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (file) restoreBackupFile(file);
      backupFileInput.value = '';
    });

    if (window.PN_MAPPINGS_API?.load) {
      window.PN_MAPPINGS_API.load()
        .then((data) => {
          updateStats(data);
          const stamp = new Date().toLocaleString('pl-PL');
          localStorage.setItem(ADMIN_LAST_SYNC_KEY, stamp);
          if (lastSyncValue) lastSyncValue.textContent = stamp;
          fetchLogs();
        })
        .catch(() => {
          showToast('Nie udało się pobrać mapowań z serwera.', 'warn');
          updateStats(window.PN_MAPPINGS_API.get());
        });
    }

    function updateStats(data) {
      const exact = data?.exact || {};
      const patterns = Array.isArray(data?.patterns) ? data.patterns : [];
      const exactCount = Object.keys(exact).length;
      const patternCount = patterns.length;
      if (exactCountEl) exactCountEl.textContent = exactCount;
      if (patternCountEl) patternCountEl.textContent = patternCount;
      if (totalCountEl) totalCountEl.textContent = exactCount + patternCount;
    }

    const lastBackup = localStorage.getItem(ADMIN_LAST_BACKUP_KEY);
    if (lastBackupValue) lastBackupValue.textContent = lastBackup || 'brak';
    const lastSync = localStorage.getItem(ADMIN_LAST_SYNC_KEY);
    if (lastSyncValue) lastSyncValue.textContent = lastSync || '—';

    async function fetchLogs({ notifySuccess = false } = {}) {
      if (!adminLogList) return;
      try {
        const t0 = performance.now();
        const resp = await window.PN_MAPPINGS_API.request('/logs?limit=200', { method: 'GET' });
        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          throw new Error(`HTTP ${resp.status}${text ? `: ${text}` : ''}`);
        }
        const data = await resp.json();
        const t1 = performance.now();
        logsCache = Array.isArray(data.logs) ? data.logs : [];
        totalLogs = Number.isFinite(data.total) ? data.total : null;
        logPage = 1;
        renderLogs();
        if (notifySuccess) {
          showToast('Logi odświeżone.', 'ok', t1 - t0);
        }
      } catch (error) {
        adminLogList.textContent = 'Nie udało się pobrać historii.';
        const message = error?.message ? `Błąd pobierania logów: ${error.message}` : 'Błąd pobierania logów z workera.';
        showToast(message, 'warn');
      }
    }

    function renderLogs() {
      if (!adminLogList) return;
      const query = (logQuery?.value || '').trim().toLowerCase();
      const typeFilter = logTypeFilter?.value || 'all';
      const pageSize = Number(logPageSize?.value) || 20;
      const filtered = logsCache.filter((entry) => {
        if (typeFilter !== 'all' && entry.type !== typeFilter) return false;
        if (!query) return true;
        const geo = entry.geo || {};
        const meta = entry.meta || {};
        const metaText = (() => {
          try {
            return JSON.stringify(meta);
          } catch (err) {
            return '';
          }
        })();
        const haystack = [
          entry.type,
          entry.ts,
          entry.ip,
          entry.clientFp,
          entry.ua,
          entry.ray,
          geo.city,
          geo.region,
          geo.country,
          geo.asn,
          metaText
        ].join(' ').toLowerCase();
        return haystack.includes(query);
      });
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      if (logPage > totalPages) logPage = totalPages;
      const start = (logPage - 1) * pageSize;
      const pageItems = filtered.slice(start, start + pageSize);
      if (logCount) {
        const countValue = Number.isFinite(totalLogs) ? totalLogs : filtered.length;
        logCount.textContent = String(countValue);
        logCount.classList.toggle('is-bad', countValue > 0);
      }
      if (!pageItems.length) {
        adminLogList.textContent = 'Brak danych.';
      } else {
        adminLogList.innerHTML = pageItems.map((entry) => {
          const type = entry.type || 'unknown';
          const ip = entry.ip || 'unknown';
          const ts = entry.ts ? new Date(entry.ts).toLocaleString('pl-PL') : '—';
          const ua = entry.ua || 'unknown';
          const fp = entry.clientFp || 'unknown';
          const geo = entry.geo || {};
          const place = [geo.city, geo.region, geo.country].filter(Boolean).join(', ') || 'unknown';
          const asn = geo.asn ? `AS${geo.asn}` : 'unknown';
          const ray = entry.ray || '—';
          const hasMeta = entry.meta && Object.keys(entry.meta).length > 0;
          const entryIndex = logsCache.indexOf(entry);
          const metaId = `meta-${entryIndex}`;
          const rawMeta = hasMeta ? escapeHtml(JSON.stringify(entry.meta)) : '';
          return `
            <div class="admin-log-item">
              <div class="log-main">
                <strong>${type}</strong>
                <div class="log-actions">
                  <span>${ts}</span>
                  ${hasMeta ? `<button type="button" class="log-pretty" data-log-index="${entryIndex}">Prettify</button>` : ''}
                </div>
              </div>
              <div class="log-sub">
                <span>IP: ${ip}</span>
                <span>FP: ${fp}</span>
                <span>${place}</span>
                <span>${asn}</span>
                <span>Ray: ${ray}</span>
              </div>
              ${hasMeta ? `
                <div class="log-meta">
                  <div class="log-meta-raw">${rawMeta}</div>
                  <pre class="log-pretty-content" id="${metaId}" hidden></pre>
                </div>
              ` : ''}
              <div class="log-ua">${ua}</div>
            </div>
          `;
        }).join('');
      }
      if (logPageInfo) {
        logPageInfo.textContent = `Strona ${logPage} / ${totalPages}`;
      }
      if (logPrevBtn) logPrevBtn.disabled = logPage <= 1;
      if (logNextBtn) logNextBtn.disabled = logPage >= totalPages;
      renderReports();
    }

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatMetaPretty(entry) {
      const meta = entry.meta || {};
      const lines = [];
      if (entry.type) lines.push(`Typ: ${entry.type}`);
      if (meta.action) lines.push(`Akcja: ${meta.action}`);
      if (entry.type === 'mapping-report') {
        const report = meta.report || {
          query: meta.query,
          suggestedVendor: meta.suggestedVendor,
          source: meta.source,
          detail: meta.detail,
          reason: meta.reason
        };
        if (report && (report.query || report.suggestedVendor || report.source || report.detail || report.reason)) {
          if (report.query) lines.push(`Zgłoszenie PN: ${report.query}`);
          if (report.suggestedVendor) lines.push(`Zgłoszony producent: ${report.suggestedVendor}`);
          if (report.reason) lines.push(`Powód: ${report.reason}`);
        }
        if (meta.mapping) {
          const m = meta.mapping || {};
          if (m.key) lines.push(`Mapa -> PN/wzorzec: ${m.key}`);
          if (m.vendor) lines.push(`Mapa -> producent: ${m.vendor}`);
          if (m.type) lines.push(`Typ wpisu: ${m.type}`);
          if (m.note) lines.push(`Uwagi admina: ${m.note}`);
        }
        if (report && (report.source || report.detail)) {
          lines.push('');
          const parts = [];
          if (report.source) parts.push(`Źródło: ${report.source}`);
          if (report.detail) parts.push(`Wzorzec: ${report.detail}`);
          lines.push(`// ${parts.join(' · ')}`);
        }
      } else {
        const flat = flattenMeta(meta);
        for (const [key, value] of Object.entries(flat)) {
          lines.push(`${key}: ${value}`);
        }
      }
      if (!lines.length) return JSON.stringify(meta, null, 2);
      return lines.join('\n');
    }

    function flattenMeta(obj, prefix = '', out = {}) {
      if (!obj || typeof obj !== 'object') return out;
      for (const [key, value] of Object.entries(obj)) {
        const nextKey = prefix ? `${prefix}.${key}` : key;
        if (value && typeof value === 'object' && !Array.isArray(value)) {
          flattenMeta(value, nextKey, out);
        } else {
          out[nextKey] = Array.isArray(value) ? value.join(', ') : String(value);
        }
      }
      return out;
    }

    const DISMISSED_REPORTS_KEY = 'adminDismissedReports';
    let dismissedReports = new Set();
    try {
      const stored = JSON.parse(localStorage.getItem(DISMISSED_REPORTS_KEY) || '[]');
      dismissedReports = new Set(stored);
    } catch (error) {
      dismissedReports = new Set();
    }

    function buildReportKeyFromMeta(meta = {}) {
      if (meta.reportId) return meta.reportId;
      const parts = [
        meta.query || '',
        meta.suggestedVendor || '',
        meta.source || '',
        meta.detail || '',
        meta.reason || ''
      ];
      const joined = parts.join('|');
      if (joined.replace(/\|/g, '').trim() === '') return '';
      return joined;
    }

    const reportKindCache = new Map();
    const reportKindLoading = new Set();

    function getReportKindOverride(reportId) {
      if (!reportId) return '';
      return reportKindCache.get(reportId) || '';
    }

    async function fetchReportKind(reportId) {
      if (!reportId || reportKindCache.has(reportId) || reportKindLoading.has(reportId)) return;
      if (!window.PN_MAPPINGS_API?.request) return;
      reportKindLoading.add(reportId);
      try {
        const resp = await window.PN_MAPPINGS_API.request(`/report-kind?id=${encodeURIComponent(reportId)}`, { method: 'GET' });
        const data = await resp.json().catch(() => ({}));
        const kind = typeof data.kind === 'string' ? data.kind : '';
        reportKindCache.set(reportId, kind);
        requestAnimationFrame(() => {
          renderReports();
        });
      } catch (error) {
        reportKindCache.set(reportId, '');
      } finally {
        reportKindLoading.delete(reportId);
      }
    }

    async function setReportKindOverride(reportId, kind) {
      if (!reportId) return;
      reportKindCache.set(reportId, kind || '');
      if (!window.PN_MAPPINGS_API?.request) return;
      try {
        if (kind) {
          await window.PN_MAPPINGS_API.request(`/report-kind?id=${encodeURIComponent(reportId)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ kind })
          });
        } else {
          await window.PN_MAPPINGS_API.request(`/report-kind?id=${encodeURIComponent(reportId)}`, { method: 'DELETE' });
        }
      } catch (error) {
        // keep cache
      }
    }

    function getReportMeta(entry) {
      if (!entry) return {};
      const meta = entry.meta || {};
      return meta.report || meta;
    }

    function getReportKind(entry) {
      const meta = getReportMeta(entry);
      const reportId = buildReportId(entry);
      const override = getReportKindOverride(reportId);
      if (override) return override;
      const inferredUi = !meta.kind && !meta.query && !meta.suggestedVendor && meta.reason;
      return meta.kind || (inferredUi ? 'ui' : 'mapping');
    }

    function buildReportKey(entry) {
      const meta = entry.meta || {};
      if (meta.reportId) return meta.reportId;
      if (meta.report && meta.report.reportId) return meta.report.reportId;
      const report = meta.report || meta;
      const metaKey = buildReportKeyFromMeta(report);
      if (metaKey) return metaKey;
      return `${entry.ts || ''}|${entry.ray || ''}`;
    }

    function persistDismissedReports() {
      localStorage.setItem(DISMISSED_REPORTS_KEY, JSON.stringify(Array.from(dismissedReports)));
    }

    function renderReports() {
      if (!reportList) return;
      const allReports = logsCache.filter((entry) => entry.type === 'mapping-report');
      const baseReports = allReports.filter((entry) => !entry?.meta?.action);
      const reportById = new Map();
      baseReports.forEach((entry) => {
        const reportId = buildReportId(entry);
        if (!reportId) return;
        const prev = reportById.get(reportId);
        if (!prev) {
          reportById.set(reportId, entry);
          return;
        }
        const prevTs = prev.ts ? Date.parse(prev.ts) : 0;
        const nextTs = entry.ts ? Date.parse(entry.ts) : 0;
        if (nextTs >= prevTs) {
          reportById.set(reportId, entry);
        }
      });
      const reports = Array.from(reportById.values());
      const mappingReports = [];
      const uiReports = [];
      reports.forEach((entry) => {
        const kind = getReportKind(entry);
        if (kind === 'ui') uiReports.push(entry);
        else mappingReports.push(entry);
      });
      const resolvedKeys = new Set();
      logsCache.forEach((entry) => {
        if (entry.type !== 'mapping-report') return;
        const action = entry?.meta?.action;
        if (!action || action === 'on-hold' || action === 'retype') return;
        const key = buildReportKey(entry);
        if (key) resolvedKeys.add(key);
      });
      const visibleReports = reports.filter((entry) => {
        const key = buildReportKey(entry);
        if (dismissedReports.has(key)) return false;
        if (resolvedKeys.has(key)) return false;
        return true;
      });
      const visibleMapping = visibleReports.filter((entry) => getReportKind(entry) !== 'ui');
      const visibleUi = visibleReports.filter((entry) => getReportKind(entry) === 'ui');
      if (reportCount) {
        reportCount.textContent = String(visibleReports.length);
        reportCount.classList.toggle('is-bad', visibleReports.length > 0);
      }
      if (!visibleReports.length) {
        reportList.textContent = 'Brak zgłoszeń.';
        return;
      }
      const sectionTemplate = (title, entries) => {
        if (!entries.length) return '';
        return `
          <div class="report-section">
            <div class="report-section-title">${title}</div>
            ${entries.map((entry, index) => renderReportItem(entry, index)).join('')}
          </div>
        `;
      };

      const filterValue = reportFilter?.value || 'all';
      let sections = [];
      if (filterValue === 'mapping') {
        sections = [sectionTemplate('Zgłoszenia mapowań', visibleMapping)];
      } else if (filterValue === 'ui') {
        sections = [sectionTemplate('Błędy działania strony', visibleUi)];
      } else {
        sections = [
          sectionTemplate('Zgłoszenia mapowań', visibleMapping),
          sectionTemplate('Błędy działania strony', visibleUi)
        ];
      }

      reportList.innerHTML = sections.join('');
      hydrateAdminNotes();
      hydrateReportKinds();

      if (!reportList.innerHTML.trim()) {
        reportList.textContent = 'Brak zgłoszeń.';
      }
    }

    function renderReportItem(entry, index) {
      const meta = getReportMeta(entry);
      const query = escapeHtml(meta.query || '');
      const suggestedVendor = escapeHtml(meta.suggestedVendor || '');
      const source = escapeHtml(meta.source || '');
      const detail = escapeHtml(meta.detail || '');
      const reason = escapeHtml(meta.reason || '');
      const ts = entry.ts ? new Date(entry.ts).toLocaleString('pl-PL') : '—';
      const reportKey = escapeHtml(buildReportKey(entry));
      const kind = getReportKind(entry);
      const kindLabel = kind === 'ui' ? 'Błąd działania strony' : 'Błąd mapowania';
      const reportId = buildReportId(entry);
      const storedNote = getAdminNote(reportId);
      if (kind === 'ui') {
        return `
          <div class="report-item report-${kind}" data-report-index="${index}" data-report-key="${reportKey}" data-report-query="${query}" data-report-vendor="${suggestedVendor}" data-report-source="${source}" data-report-detail="${detail}" data-report-reason="${reason}" data-report-kind="${kind}" data-report-id="${reportId}">
            <div class="report-header">
              <strong>ID: ${reportId}</strong>
              <div class="report-header-meta">
                <span class="report-ts">${ts}</span>
                <div class="report-meta-row">
                  <span class="report-kind">${kindLabel}</span>
                  <button type="button" class="report-kind-toggle" aria-label="Zmień typ zgłoszenia">↔</button>
                </div>
              </div>
            </div>
            ${reason ? `<div class="report-reason"><span class="report-reason-label">Uwagi:</span> <strong>${reason}</strong></div>` : ''}
            <div class="report-form">
              <textarea class="report-note" rows="2" placeholder="Notatki admina (opcjonalne)">${storedNote}</textarea>
              <div class="report-actions">
                <button type="button" class="report-resolve">Resolved</button>
                <button type="button" class="report-hold">On hold</button>
                <button type="button" class="report-dismiss">Usuń zgłoszenie</button>
              </div>
              ${(source || detail) ? `<div class="report-extra">// ${source ? `Źródło: ${source}` : ''}${detail ? ` · Wzorzec: ${detail}` : ''}</div>` : ''}
            </div>
          </div>
        `;
      }
      return `
          <div class="report-item report-${kind}" data-report-index="${index}" data-report-key="${reportKey}" data-report-query="${query}" data-report-vendor="${suggestedVendor}" data-report-source="${source}" data-report-detail="${detail}" data-report-reason="${reason}" data-report-kind="${kind}" data-report-id="${reportId}">
            <div class="report-header">
              <strong>${query || '—'}</strong>
              <div class="report-header-meta">
                <span class="report-ts">${ts}</span>
                <div class="report-meta-row">
                  <span class="report-kind">${kindLabel}</span>
                  <button type="button" class="report-kind-toggle" aria-label="Zmień typ zgłoszenia">↔</button>
                  <span class="report-id">ID: ${reportId}</span>
                </div>
              </div>
            </div>
            <div class="report-meta">
              <span>Sugestia: <strong>${suggestedVendor || '—'}</strong></span>
              <span>Źródło: ${source || '—'}</span>
              ${detail ? `<span>Wzorzec: ${detail}</span>` : ''}
            </div>
            ${reason ? `<div class="report-reason"><span class="report-reason-label">Uwagi:</span> <strong>${reason}</strong></div>` : ''}
            <div class="report-form">
              <input type="text" class="report-key" placeholder="PN lub wzorzec" value="${query}">
              <input type="text" class="report-vendor" placeholder="Producent (np. Dell)" value="${suggestedVendor}">
              <div class="report-mode">
                <label>Typ wpisu</label>
                <select class="report-type">
                  <option value="auto" selected>Auto (PN lub wzorzec)</option>
                  <option value="exact">PN exact</option>
                  <option value="pattern">Wzorzec</option>
                </select>
              </div>
              <textarea class="report-note" rows="2" placeholder="Uwagi admina / powód korekty" disabled>${reason}</textarea>
              <div class="report-actions">
                <button type="button" class="report-apply">Dodaj / popraw mapowanie</button>
                <button type="button" class="report-dismiss">Usuń zgłoszenie</button>
              </div>
            </div>
          </div>
        `;
    }

    function buildReportId(entry) {
      const meta = entry.meta || {};
      if (meta.reportId) return meta.reportId;
      if (meta.report && meta.report.reportId) return meta.report.reportId;
      const report = meta.report || {
        query: meta.query,
        suggestedVendor: meta.suggestedVendor,
        source: meta.source,
        detail: meta.detail,
        reason: meta.reason
      };
      const raw = [
        entry.ts || '',
        entry.ray || '',
        report.query || '',
        report.suggestedVendor || '',
        report.source || '',
        report.detail || '',
        report.reason || ''
      ].join('|');
      let hash = 5381;
      for (let i = 0; i < raw.length; i += 1) {
        hash = ((hash << 5) + hash) + raw.charCodeAt(i);
      }
      return `R-${(hash >>> 0).toString(16).slice(0, 8)}`;
    }

    const adminNotesCache = new Map();
    const adminNotesLoading = new Set();

    function getAdminNote(reportId) {
      if (!reportId) return '';
      return adminNotesCache.get(reportId) || '';
    }

    async function fetchAdminNote(reportId) {
      if (!reportId || adminNotesCache.has(reportId) || adminNotesLoading.has(reportId)) return;
      if (!window.PN_MAPPINGS_API?.request) return;
      adminNotesLoading.add(reportId);
      try {
        const resp = await window.PN_MAPPINGS_API.request(`/notes?id=${encodeURIComponent(reportId)}`, { method: 'GET' });
        const data = await resp.json().catch(() => ({}));
        const note = typeof data.note === 'string' ? data.note : '';
        adminNotesCache.set(reportId, note);
        const field = document.querySelector(`.report-item[data-report-id="${reportId}"] .report-note`);
        if (field) field.value = note;
      } catch (error) {
        adminNotesCache.set(reportId, '');
      } finally {
        adminNotesLoading.delete(reportId);
      }
    }

    async function setAdminNote(reportId, note) {
      if (!reportId) return;
      adminNotesCache.set(reportId, note || '');
      if (!window.PN_MAPPINGS_API?.request) return;
      try {
        if (note) {
          await window.PN_MAPPINGS_API.request(`/notes?id=${encodeURIComponent(reportId)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ note })
          });
        } else {
          await window.PN_MAPPINGS_API.request(`/notes?id=${encodeURIComponent(reportId)}`, { method: 'DELETE' });
        }
      } catch (error) {
        // ignore, cache still holds latest note
      }
    }

    function isPatternValue(value) {
      return /[x*+]/i.test(value);
    }

    function getReportMetaFromItem(item) {
      if (!item) return {};
      return {
        query: item.getAttribute('data-report-query') || '',
        suggestedVendor: item.getAttribute('data-report-vendor') || '',
        source: item.getAttribute('data-report-source') || '',
        detail: item.getAttribute('data-report-detail') || '',
        reason: item.getAttribute('data-report-reason') || '',
        kind: item.getAttribute('data-report-kind') || 'mapping',
        reportId: item.getAttribute('data-report-id') || ''
      };
    }

    function hydrateAdminNotes() {
      const noteFields = Array.from(document.querySelectorAll('.report-item .report-note'));
      noteFields.forEach((field) => {
        const reportId = field.closest('.report-item')?.getAttribute('data-report-id') || '';
        if (!reportId) return;
        if (!adminNotesCache.has(reportId)) {
          fetchAdminNote(reportId);
        }
      });
    }

    function hydrateReportKinds() {
      const items = Array.from(document.querySelectorAll('.report-item'));
      items.forEach((item) => {
        const reportId = item.getAttribute('data-report-id') || '';
        if (!reportId) return;
        if (!reportKindCache.has(reportId)) {
          fetchReportKind(reportId);
        }
      });
    }

    function applyReportMappingFromData({ rawKey, vendor, note, typeMode }) {
      if (!rawKey || !vendor) {
        showToast('Uzupełnij PN/wzorzec i producenta.', 'warn');
        return;
      }
      const data = window.PN_MAPPINGS_API.get();
      const treatAsPattern = typeMode === 'pattern' || (typeMode === 'auto' && isPatternValue(rawKey));
      if (treatAsPattern) {
        const pattern = window.PN_MAPPINGS_API.normalizePattern(rawKey);
        data.patterns = Array.isArray(data.patterns) ? data.patterns : [];
        const existing = data.patterns.find((rule) => rule.pattern === pattern);
        if (existing) {
          existing.vendor = vendor;
        } else {
          data.patterns.push({ pattern, vendor });
        }
        window.PN_MAPPINGS_API.set(data);
        showToast(`Zapisano wzorzec: ${pattern} → ${vendor}`, 'ok');
        window.PN_MAPPINGS_API.log('mapping', { action: 'apply-report-pattern', pattern, vendor, note });
      } else {
        const key = window.PN_MAPPINGS_API.normalize(rawKey);
        data.exact = data.exact || {};
        data.exact[key] = vendor;
        window.PN_MAPPINGS_API.set(data);
        showToast(`Zapisano PN: ${key} → ${vendor}`, 'ok');
        window.PN_MAPPINGS_API.log('mapping', { action: 'apply-report-exact', key, vendor, note });
      }
      updateStats(window.PN_MAPPINGS_API.get());
    }

    function logReportAction(meta) {
      if (window.PN_MAPPINGS_API?.request) {
        window.PN_MAPPINGS_API.request('/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'mapping-report', meta })
        }).catch(() => {
          window.PN_MAPPINGS_API?.log?.('mapping-report', meta);
        });
        return;
      }
      window.PN_MAPPINGS_API?.log?.('mapping-report', meta);
    }

    function closeReportConfirmModal() {
      if (!reportConfirmModal) return;
      reportConfirmModal.style.display = 'none';
      pendingReportApply = null;
    }

    function openReportConfirmModal(item) {
      if (!item || !reportConfirmModal) return;
      const keyInput = item.querySelector('.report-key');
      const vendorInput = item.querySelector('.report-vendor');
      const noteInput = item.querySelector('.report-note');
      const typeSelect = item.querySelector('.report-type');
      const rawKey = keyInput?.value?.trim() || '';
      const vendor = vendorInput?.value?.trim() || '';
      const reason = noteInput?.value?.trim() || '';
      const typeMode = typeSelect?.value || 'auto';
      if (reportConfirmKey) reportConfirmKey.value = rawKey;
      if (reportConfirmVendor) reportConfirmVendor.value = vendor;
      if (reportConfirmType) reportConfirmType.value = typeMode;
      if (reportConfirmNote) reportConfirmNote.value = '';
      if (reportConfirmInfo) {
        reportConfirmInfo.textContent = reason ? `Powód zgłoszenia: ${reason}` : 'Powód zgłoszenia: —';
      }
      pendingReportApply = {
        sourceReason: reason,
        reportKey: item.getAttribute('data-report-key') || '',
        reportItem: item,
        reportMeta: getReportMetaFromItem(item)
      };
      reportConfirmModal.style.display = 'flex';
      reportConfirmKey?.focus();
    }

    function closeReportDismissModal() {
      if (!reportDismissModal) return;
      reportDismissModal.style.display = 'none';
      pendingReportDismiss = null;
    }

    function openReportDismissModal(item) {
      if (!item || !reportDismissModal) return;
      const key = item.getAttribute('data-report-key') || '';
      const title = item.querySelector('.report-header strong')?.textContent || 'zgłoszenie';
      const reportId = item.getAttribute('data-report-id') || '';
      if (reportDismissMessage) {
        const idSuffix = reportId ? ` (${reportId})` : '';
        reportDismissMessage.textContent = `Czy na pewno chcesz usunąć zgłoszenie: ${title}${idSuffix}?`;
      }
      const meta = getReportMetaFromItem(item);
      pendingReportDismiss = { key, item, meta };
      reportDismissModal.style.display = 'flex';
    }

    function closeReportRetypeModal() {
      if (!reportRetypeModal) return;
      reportRetypeModal.style.display = 'none';
      pendingReportRetype = null;
    }

    function openReportRetypeModal(item, nextKind) {
      if (!item || !reportRetypeModal) return;
      const title = item.querySelector('.report-header strong')?.textContent || 'zgłoszenie';
      if (reportRetypeMessage) {
        const label = nextKind === 'ui' ? 'Błąd działania strony' : 'Błąd mapowania';
        reportRetypeMessage.textContent = `Zmień typ ${title} na: ${label}?`;
      }
      pendingReportRetype = {
        reportId: item.getAttribute('data-report-id') || '',
        nextKind
      };
      reportRetypeModal.style.display = 'flex';
    }

    [logTypeFilter, logQuery, logPageSize].forEach((el) => {
      if (!el) return;
      el.addEventListener('input', () => {
        logPage = 1;
        renderLogs();
      });
      el.addEventListener('change', () => {
        logPage = 1;
        renderLogs();
      });
    });
    if (logRefreshBtn) {
      logRefreshBtn.addEventListener('click', () => {
        fetchLogs({ notifySuccess: true });
      });
    }
    if (logPrevBtn) {
      logPrevBtn.addEventListener('click', () => {
        logPage = Math.max(1, logPage - 1);
        renderLogs();
      });
    }
    if (logNextBtn) {
      logNextBtn.addEventListener('click', () => {
        logPage += 1;
        renderLogs();
      });
    }
    if (reportFilter) {
      reportFilter.addEventListener('change', () => {
        renderReports();
      });
    }
    if (adminLogList) {
      adminLogList.addEventListener('click', (event) => {
        const target = event.target;
        if (!target) return;
        const prettyBtn = target.closest('.log-pretty');
        if (!prettyBtn) return;
        const idx = Number(prettyBtn.getAttribute('data-log-index'));
        if (Number.isNaN(idx)) return;
        const entry = logsCache[idx];
        const pre = document.getElementById(`meta-${idx}`);
        if (!pre || !entry?.meta) return;
        const raw = pre.closest('.log-meta')?.querySelector('.log-meta-raw');
        if (pre.hasAttribute('hidden')) {
          pre.textContent = formatMetaPretty(entry);
          pre.removeAttribute('hidden');
          if (raw) raw.setAttribute('hidden', 'hidden');
          prettyBtn.textContent = 'Ukryj';
        } else {
          pre.setAttribute('hidden', 'hidden');
          if (raw) raw.removeAttribute('hidden');
          prettyBtn.textContent = 'Prettify';
        }
      });
    }
    if (reportList) {
      reportList.addEventListener('click', (event) => {
        const target = event.target;
        if (!target) return;
        const kindToggle = target.closest('.report-kind-toggle');
        if (kindToggle) {
          const item = kindToggle.closest('.report-item');
          if (!item) return;
          const current = item.getAttribute('data-report-kind') || 'mapping';
          const next = current === 'ui' ? 'mapping' : 'ui';
          openReportRetypeModal(item, next);
          return;
        }
        const applyBtn = target.closest('.report-apply');
        if (applyBtn) {
          const item = applyBtn.closest('.report-item');
          openReportConfirmModal(item);
          return;
        }
        const resolveBtn = target.closest('.report-resolve');
        if (resolveBtn) {
          const item = resolveBtn.closest('.report-item');
          if (!item) return;
          const reportMeta = getReportMetaFromItem(item);
          reportMeta.kind = 'ui';
          const adminNote = item.querySelector('.report-note')?.value?.trim() || '';
          const reportId = item.getAttribute('data-report-id') || '';
          setAdminNote(reportId, adminNote);
          logReportAction({
            action: 'resolved',
            report: reportMeta,
            mapping: {
              key: 'nie dotyczy',
              vendor: 'nie dotyczy',
              type: 'działanie strony',
              note: adminNote || 'nie dotyczy'
            }
          });
          if (reportMeta) {
            const key = buildReportKeyFromMeta(reportMeta);
            if (key) {
              dismissedReports.add(key);
              persistDismissedReports();
            }
          }
          item.remove();
          showToast('Zgłoszenie oznaczone jako resolved.', 'ok');
          renderReports();
          return;
        }
        const holdBtn = target.closest('.report-hold');
        if (holdBtn) {
          const item = holdBtn.closest('.report-item');
          if (!item) return;
          const reportMeta = getReportMetaFromItem(item);
          reportMeta.kind = 'ui';
          const adminNote = item.querySelector('.report-note')?.value?.trim() || '';
          const reportId = item.getAttribute('data-report-id') || '';
          setAdminNote(reportId, adminNote);
          logReportAction({
            action: 'on-hold',
            report: reportMeta,
            mapping: {
              key: 'nie dotyczy',
              vendor: 'nie dotyczy',
              type: 'działanie strony',
              note: adminNote || 'nie dotyczy'
            }
          });
          showToast('Zgłoszenie oznaczone jako on hold.', 'info');
          return;
        }
        const dismissBtn = target.closest('.report-dismiss');
        if (!dismissBtn) return;
        const item = dismissBtn.closest('.report-item');
        if (!item) return;
        const reportId = item.getAttribute('data-report-id') || '';
        setAdminNote(reportId, '');
        openReportDismissModal(item);
      });
    }

    if (reportConfirmClose) {
      reportConfirmClose.addEventListener('click', closeReportConfirmModal);
    }
    if (reportConfirmCancel) {
      reportConfirmCancel.addEventListener('click', closeReportConfirmModal);
    }
    if (reportConfirmApply) {
      reportConfirmApply.addEventListener('click', () => {
        const rawKey = reportConfirmKey?.value?.trim() || '';
        const vendor = reportConfirmVendor?.value?.trim() || '';
        const note = reportConfirmNote?.value?.trim() || '';
        const typeMode = reportConfirmType?.value || 'auto';
        const uiStatus = reportConfirmStatus?.value || 'resolved';
        if (rawKey && vendor) {
          applyReportMappingFromData({ rawKey, vendor, note, typeMode });
          logReportAction({
            action: 'resolved',
            report: pendingReportApply?.reportMeta || {},
            mapping: {
              key: rawKey,
              vendor,
              type: typeMode,
              note
            }
          });
          showToast('Zgłoszenie zamknięte po zapisie mapowania.', 'ok');
        } else {
          const reportMeta = pendingReportApply?.reportMeta || {};
          reportMeta.kind = 'ui';
          logReportAction({
            action: uiStatus === 'on-hold' ? 'on-hold' : 'resolved',
            report: reportMeta,
            mapping: {
              key: 'nie dotyczy',
              vendor: 'nie dotyczy',
              type: 'działanie strony',
              note: note || 'nie dotyczy'
            }
          });
          if (uiStatus === 'on-hold') {
            showToast('Zgłoszenie oznaczone jako on hold.', 'info');
          } else {
            showToast('Zgłoszenie zamknięte jako problem działania strony.', 'ok');
          }
        }
        if (uiStatus !== 'on-hold') {
          if (pendingReportApply?.reportKey) {
            dismissedReports.add(pendingReportApply.reportKey);
            persistDismissedReports();
          }
          if (pendingReportApply?.reportItem) {
            pendingReportApply.reportItem.remove();
          }
        }
        renderReports();
        closeReportConfirmModal();
      });
    }

    if (reportDismissClose) {
      reportDismissClose.addEventListener('click', closeReportDismissModal);
    }
    if (reportDismissCancel) {
      reportDismissCancel.addEventListener('click', closeReportDismissModal);
    }
    if (reportDismissApply) {
      reportDismissApply.addEventListener('click', () => {
        if (pendingReportDismiss?.key) {
          dismissedReports.add(pendingReportDismiss.key);
          persistDismissedReports();
        }
        if (pendingReportDismiss?.item) {
          pendingReportDismiss.item.remove();
        }
        logReportAction({
          action: 'dismissed',
          report: pendingReportDismiss?.meta || {}
        });
        showToast('Zgłoszenie usunięte.', 'ok');
        renderReports();
        closeReportDismissModal();
      });
    }

    if (reportRetypeClose) {
      reportRetypeClose.addEventListener('click', closeReportRetypeModal);
    }
    if (reportRetypeCancel) {
      reportRetypeCancel.addEventListener('click', closeReportRetypeModal);
    }
    if (reportRetypeApply) {
      reportRetypeApply.addEventListener('click', () => {
        if (!pendingReportRetype) return;
        const { reportId, nextKind } = pendingReportRetype;
        if (!reportId) {
          closeReportRetypeModal();
          return;
        }
        setReportKindOverride(reportId, nextKind);
        const entry = logsCache.find((log) => buildReportId(log) === reportId);
        if (entry && entry.meta) {
          entry.meta.kind = nextKind;
        }
        logReportAction({
          action: 'retype',
          report: entry?.meta || { reportId },
          newKind: nextKind
        });
        showToast('Zmieniono typ zgłoszenia.', 'ok');
        renderReports();
        closeReportRetypeModal();
      });
    }

    setInterval(() => {
      fetchLogs();
    }, 30000);

  </script>
</body>
</html>
